<div [ngClass]="getClassNames('switchRow')">

  @if (allowCollapse) {
    <a (click)="toggleCollapse()"
       [ngClass]="getClassNames('arrowIconButton', data.collapsed ? 'collapsed' : '')">
       @if (getArrowIconTemplate(); as template) {
          <ng-container *ngTemplateOutlet="template; context: getArrowIconContext()"></ng-container>
       } @else {  
          <i [ngClass]="getClassNames('arrowIcon')"></i>
       }
    </a>

  }

  @if (getButtonGroupTemplate(); as template) {
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
      <ng-container *ngTemplateOutlet="template; context: getButtonGroupContext()"></ng-container>
    </div>
  } @else {
    <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
      <button
        type="button"
        (click)="addRule()"
        [ngClass]="getClassNames('button')"
        [disabled]="disabled"
      >
        <i [ngClass]="getClassNames('addIcon')"></i> Rule
      </button>
      @if (allowRuleset) {
        <button type="button"
                (click)="addRuleSet()"
                [ngClass]="getClassNames('button')"
                [disabled]="disabled">
          <i [ngClass]="getClassNames('addIcon')"></i> Ruleset
        </button>
      }
      @if (!!parentValue && allowRuleset) {
        <button
          type="button"
          (click)="removeRuleSet()"
          [ngClass]="getClassNames('button', 'removeButton')"
          [disabled]="disabled">
          <i [ngClass]="getClassNames('removeIcon')"></i>
        </button>
      }
    </div>
  }

  @if (getSwitchGroupTemplate(); as template) {
    <ng-container *ngTemplateOutlet="template; context: getSwitchGroupContext()"></ng-container>
  } @else if (data) {
    <div [ngClass]="getClassNames('switchGroup', 'transition')">
      <div [ngClass]="getClassNames('switchControl')">
        <input
          type="radio"
          [ngClass]="getClassNames('switchRadio')"
          [(ngModel)]="data.condition"
          [disabled]="disabled"
          value="and"
          #andOption
        />
        <label (click)="changeCondition(andOption.value)" [ngClass]="getClassNames('switchLabel')"
          >AND</label
        >
      </div>
      <div [ngClass]="getClassNames('switchControl')">
        <input
          type="radio"
          [ngClass]="getClassNames('switchRadio')"
          [(ngModel)]="data.condition"
          [disabled]="disabled"
          value="or"
          #orOption
        />
        <label (click)="changeCondition(orOption.value)" [ngClass]="getClassNames('switchLabel')"
          >OR</label
        >
      </div>
    </div>
  }
</div>

<div #treeContainer (transitionend)="transitionEnd($event)" [ngClass]="getClassNames('treeContainer', data.collapsed ? 'collapsed' : '')">
  @if (data && data.rules) {
    <ul [ngClass]="getClassNames('tree')">
      @for (entityRule of data.rules; track $index; let i = $index) {
          @if ({
            ruleset: !!entityRule.rules,
            invalid: !config.allowEmptyRulesets && entityRule.rules && entityRule.rules.length === 0
          }; as local) {
            <li [ngClass]="getQueryItemClassName(local)">
              @if (!local.ruleset) {
                @if (getAddFieldRuleButtonTemplate(); as template) {
                  <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
                    <ng-container *ngTemplateOutlet="template; context: getAddRuleFieldButtonContext(entityRule)"/>
                  </div>
                } @else {
                  <div [ngClass]="getClassNames('rightAlign')">
                    <button type="button" 
                            [ngClass]="getClassNames('button')"
                            (click)="addFieldRule(entityRule)"
                            [disabled]="disabled">
                      <i [ngClass]="getClassNames('addIcon')"></i>
                    </button>
                  </div>

                }
                @if (getRemoveButtonTemplate(); as template) {
                  <div [ngClass]="getClassNames('buttonGroup', 'rightAlign')">
                    <ng-container *ngTemplateOutlet="template; context: getRemoveButtonContext(entityRule)"/>
                  </div>
                } @else {
                  <div [ngClass]="getClassNames('removeButtonSize', 'rightAlign')">
                    <button type="button" 
                            [ngClass]="getClassNames('button', 'removeButton')"
                            (click)="removeEntityRule(entityRule, data)"
                            [disabled]="disabled">
                      <i [ngClass]="getClassNames('removeIcon')"></i>
                    </button>
                  </div>
                }
                @if (entities.length) {
                  <div class="q-inline-block-display">
                    @if (getEntityTemplate(); as template) {
                      <ng-container *ngTemplateOutlet="template; context: getEntityContext(entityRule)"/>
                    } @else {
                      <div [ngClass]="getClassNames('entityControlSize')">
                        <select [ngClass]="getClassNames('entityControl')"
                              [(ngModel)]="entityRule.entity"
                              (ngModelChange)="changeEntity($event, entityRule, i, data)"
                              [disabled]="disabled">
                          @for (entity of entities; track $index) {
                            <option [ngValue]="entity.value">
                              {{ entity.name }}
                            </option>
                          }
                        </select>
                      </div>
                    }
                  </div>
                }
      
                <ul [ngClass]="getClassNames('tree')">
                  @for (rule of entityRule.fields; track $index;) {
                    <li [ngClass]="getQueryItemClassName(local)">          

                      @if (getFieldTemplate(); as template) {
                        <ng-container *ngTemplateOutlet="template; context: getFieldContext(rule)"/>
                      } @else {
                        <div [ngClass]="getClassNames('fieldControlSize')">
                          <select
                            [ngClass]="getClassNames('fieldControl')"
                            [(ngModel)]="rule.field"
                            (ngModelChange)="changeField($event, rule)"
                            [disabled]="disabled"
                          >
                            @for (field of getFields(rule.entity); track $index) {
                              <option [ngValue]="field.value">
                                {{ field.name }}
                              </option>
                            }
                          </select>
                        </div>
                      }
            
                      @if (getOperatorTemplate(); as template) {
                        <ng-container *ngTemplateOutlet="template; context: getOperatorContext(rule)"/>
                      } @else { 
                        <div [ngClass]="getClassNames('operatorControlSize')">
                          <select
                            [ngClass]="getClassNames('operatorControl')"
                            [(ngModel)]="rule.operator"
                            (ngModelChange)="changeOperator(rule)"
                            [disabled]="disabled"
                          >
                            @for (operator of getOperators(rule.field); track $index) {
                              <option [ngValue]="operator">
                                {{ operator }}
                              </option>
                            }
                          </select>
                        </div>
                      }
        
                      @if (findTemplateForRule(rule); as template) {
                        <ng-container *ngTemplateOutlet="template; context: getInputContext(rule)"/>
                      } @else {
                        <div
                          [ngClass]="getClassNames('inputControlSize')"
                          [ngSwitch]="getInputType(rule.field, rule.operator)"
                        >
                          <input
                            [ngClass]="getClassNames('inputControl')"
                            [(ngModel)]="rule.value"
                            (ngModelChange)="changeInput()"
                            [disabled]="disabled"
                            *ngSwitchCase="'string'"
                            type="text"
                          />
                          <input
                            [ngClass]="getClassNames('inputControl')"
                            [(ngModel)]="rule.value"
                            (ngModelChange)="changeInput()"
                            [disabled]="disabled"
                            *ngSwitchCase="'number'"
                            type="number"
                          />
                          <input
                            [ngClass]="getClassNames('inputControl')"
                            [(ngModel)]="rule.value"
                            (ngModelChange)="changeInput()"
                            [disabled]="disabled"
                            *ngSwitchCase="'date'"
                            type="date"
                          />
                          <input
                            [ngClass]="getClassNames('inputControl')"
                            [(ngModel)]="rule.value"
                            (ngModelChange)="changeInput()"
                            [disabled]="disabled"
                            *ngSwitchCase="'time'"
                            type="time"
                          />
                          <select
                            [ngClass]="getClassNames('inputControl')"
                            [(ngModel)]="rule.value"
                            (ngModelChange)="changeInput()"
                            [disabled]="disabled"
                            *ngSwitchCase="'category'">
                            @for (opt of getOptions(rule.field); track $index;) {
                              <option [ngValue]="opt.value">
                                {{ opt.name }}
                              </option>
                            }
                          </select>
                          <ng-container *ngSwitchCase="'multiselect'">
                            <select
                              [ngClass]="getClassNames('inputControl')"
                              [(ngModel)]="rule.value"
                              (ngModelChange)="changeInput()"
                              [disabled]="disabled"
                              multiple
                            >
                              @for (opt of getOptions(rule.field); track $index;) {
                                <option [ngValue]="opt.value">
                                  {{ opt.name }}
                                </option>
                              }
                            </select>
                          </ng-container>
                          <input
                            [ngClass]="getClassNames('inputControl')"
                            [(ngModel)]="rule.value"
                            (ngModelChange)="changeInput()"
                            [disabled]="disabled"
                            *ngSwitchCase="'boolean'"
                            type="checkbox"
                          />
                        </div>
                      }
                    </li>
                  }
                </ul>
  
                
              } @else {
                <query-builder
                  [data]="entityRule"
                  [disabled]="disabled"
                  [parentTouchedCallback]="parentTouchedCallback || onTouchedCallback"
                  [parentChangeCallback]="parentChangeCallback || onChangeCallback"
                  [parentInputTemplates]="parentInputTemplates || inputTemplates"
                  [parentOperatorTemplate]="parentOperatorTemplate || operatorTemplate"
                  [parentFieldTemplate]="parentFieldTemplate || fieldTemplate"
                  [parentEntityTemplate]="parentEntityTemplate || entityTemplate"
                  [parentSwitchGroupTemplate]="parentSwitchGroupTemplate || switchGroupTemplate"
                  [parentButtonGroupTemplate]="parentButtonGroupTemplate || buttonGroupTemplate"
                  [parentRemoveButtonTemplate]="parentRemoveButtonTemplate || removeButtonTemplate"
                  [parentEmptyWarningTemplate]="parentEmptyWarningTemplate || emptyWarningTemplate"
                  [parentArrowIconTemplate]="parentArrowIconTemplate || arrowIconTemplate"
                  [parentValue]="data"
                  [classNames]="classNames"
                  [config]="config"
                  [allowRuleset]="allowRuleset"
                  [allowCollapse]="allowCollapse"
                  [emptyMessage]="emptyMessage"
                  [operatorMap]="operatorMap"/>
              }
              
              @if (local.invalid) {
                @if (getEmptyWarningTemplate(); as template) {
                    <ng-container *ngTemplateOutlet="template; context: getEmptyWarningContext()"/>
                } @else {
                  <p [ngClass]="getClassNames('emptyWarning')">
                    {{ emptyMessage }}
                  </p>
                }
              }
            </li>
          }
      }
    </ul>
  }
</div>
