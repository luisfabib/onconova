<p-card styleClass="h-[65rem]">
    <div class="flex mb-3">
        <p-toolbar styleClass="my-auto">
            <ng-template #start>
                @let userDatasets = userDatasets$ | async;
                @if (userDatasets) {
                    <p-autocomplete 
                        [(ngModel)]="selectedDataset" 
                        [dropdown]="true" 
                        [suggestions]="userDatasetOptions" 
                        placeholder="Enter new or existing dataset name"
                        class="mr-2" 
                        optionLabel="name"
                        (completeMethod)="searchUserDatasets($event)"/>
                }
                <p-button icon="pi pi-eraser" label='Clear' 
                    (onClick)="clearDatasetRules()"
                    class="mr-2" severity="secondary"/>
                <p-button icon="pi pi-sync" label="Load" 
                    (onClick)="loadUserDataset()"
                    [disabled]="!selectedDataset || (selectedDataset && selectedDataset | isString)"
                    class="mr-2" severity="secondary"/>
                <p-button icon="pi pi-trash" label='Delete'
                    (onClick)="deleteUserDataset()" 
                    [disabled]="!selectedDataset || (selectedDataset && selectedDataset | isString)"
                    class="mr-2" severity="secondary"/>
                <p-button icon="pi pi-cloud-upload" [label]="(selectedDataset | isString) ? 'Save new dataset' : 'Update existing dataset' "  
                    (onClick)="createUserDataset()"
                    [disabled]="!selectedDataset || !datasetRules"
                    class="mr-2" severity="secondary"/>
            </ng-template>
            <ng-template #end>
            </ng-template>
        </p-toolbar>
        <p-menu #downloadMenu [model]="items" [popup]="true" />
        <p-button 
            [icon]="authService.user.canExportData ? 'pi pi-download' : 'pi pi-lock'" 
            label="Download Dataset" 
            class="my-auto ml-auto"
            (onClick)="downloadMenu.toggle($event)"
            [disabled]="!authService.user.canExportData"/>
    </div>
    <div class="flex gap-4">

        <div>
            <div class="flex-auto md:flex md:justify-start md:items-center flex-col">
                <p-tree 
                    [value]="resourceItems" 
                    selectionMode="checkbox" 
                    [(selection)]="selectedNodes"
                    (selectionChange)="updateDataset($event)"
                    styleClass="pop-data-selector-tree md:w-[30rem]"
                    [filter]="true" 
                    filterPlaceholder="Search and select">

                    <ng-template let-node pTemplate="CodedConcept">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="date">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="string">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="integer">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="number">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="default">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                </p-tree>
            </div>
        </div>
        @if (dataset$) {
            @let dataset = dataset$ | async;
            <div class="pop-dataset-table">            
                @if (dataset) {
                    <p-table 
                        [value]="dataset || []" 
                        [scrollable]="true"
                        [paginator]="true" 
                        [showCurrentPageReport]="true"
                        lazy="true"
                        [rows]="pageSize" 
                        [rowsPerPageOptions]="pageSizeChoices"
                        [totalRecords]="totalEntries"
                        (onLazyLoad)="setPaginationAndRefresh($event)"
                        [rowsPerPageOptions]="[10, 25, 50]"
                        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                        scrollHeight="flex"
                        showGridlines>

                        <ng-template pTemplate="header">
                            <tr>
                                @for (col of getColumns(dataset); track $index; let first = $first) {
                                    <th pFrozenColumn [frozen]="first">{{ col | camelCaseToTitleCase }}</th>
                                }
                            </tr>
                        </ng-template>
                    
                        <ng-template pTemplate="body" let-rowData>
                            <tr @fadeAnimation> 
                                @for (col of getColumns(dataset); track $index; let first = $first) {
                                    <td pFrozenColumn [frozen]="first">
                                        @if (isNested(rowData[col])) {
                                            <!-- Check if the value is an object/array (nested structure) -->
                                            <div class="flex">
                                                <p-button 
                                                    [icon]="rowData[col].expanded ? 'pi pi-minus' : 'pi pi-plus'" 
                                                    [rounded]="true" 
                                                    [outlined]="true"
                                                    (onClick)="rowData[col].expanded = !rowData[col].expanded"
                                                    class="expand-nested-table-button"/>
                                                <div>
                                                    @if (rowData[col].expanded) {
                                                        <pop-nested-table [nestedData]="rowData[col]"></pop-nested-table>
                                                    } @else {
                                                        {{ rowData[col].length }} entries
                                                    }
                                                </div>
                                            </div>
                                        } @else {
                                            <!-- If it's a simple value, display normally -->
                                             @if (first) {
                                                <div class="flex gap-3">
                                                    <p-avatar size="normal" [style]="{'background': 'none', 'border': 'none', 'padding': '0'}">
                                                        <svg class="jdenticon" width="2rem" height="2rem" [data-jdenticon-value]="[rowData[col]]"></svg>
                                                    </p-avatar>
                                                    <div class="my-auto">
                                                        {{ rowData[col] }}
                                                    </div>
                                                </div>
                                            } @else if (isArray(rowData[col])) {
                                                <ul class="list-none pl-0  overflow-y-auto max-h-15rem">
                                                    @for (value of rowData[col]; track $index;) {
                                                        <li class="mb-2">ðŸž„ {{ value || '-' }}</li>
                                                    }
                                                </ul>
                                             } @else {
                                                {{ rowData[col] || '-' }}
                                             }
                                        }                            
                                    </td>
                                }
                            </tr>                        
                        </ng-template>
                    </p-table>
                } @else {
                    <p-skeleton height="100%"/>
                }
            </div>
        }
    </div>
</p-card>