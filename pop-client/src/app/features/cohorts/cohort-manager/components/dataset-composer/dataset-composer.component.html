<p-card styleClass="h-[65rem]">
    <div class="flex mb-3">
        <p-toolbar styleClass="my-auto mr-3">
            <ng-template #start>
                @let userDatasets = userDatasets$ | async;
                @if (userDatasets) {
                    <p-autocomplete 
                        [(ngModel)]="selectedDataset" 
                        [dropdown]="true" 
                        [suggestions]="userDatasetOptions" 
                        placeholder="Enter new or existing dataset name"
                        class="mr-2" 
                        optionLabel="name"
                        (completeMethod)="searchUserDatasets($event)"/>
                }
                <p-button icon="pi pi-eraser" label='Clear' 
                    (onClick)="this.selectedRules.set([])"
                    class="mr-2" severity="secondary"/>
                <p-button icon="pi pi-sync" label="Load" 
                    (onClick)="loadUserDataset()"
                    [disabled]="!selectedDataset || (selectedDataset && selectedDataset | isString)"
                    class="mr-2" severity="secondary"/>
                <p-button icon="pi pi-trash" label='Delete'
                    (onClick)="deleteUserDataset()" 
                    [disabled]="!selectedDataset || (selectedDataset && selectedDataset | isString)"
                    class="mr-2" severity="secondary"/>
                <p-button icon="pi pi-cloud-upload" [label]="(selectedDataset | isString) ? 'Save new dataset' : 'Update existing dataset' "  
                    (onClick)="createUserDataset()"
                    [disabled]="!selectedDataset || !datasetRules"
                    class="mr-2" severity="secondary"/>
            </ng-template>
            <ng-template #end>
            </ng-template>
        </p-toolbar>
        <p-menu #downloadMenu [model]="downloadMenuItems" [popup]="true" />
        <p-button 
            [icon]="user().canExportData ? 'pi pi-download' : 'pi pi-lock'" 
            label="Download Dataset" 
            class="my-auto ml-auto"
            (onClick)="downloadMenu.toggle($event)"
            [disabled]="!user().canExportData"/>
    </div>
    <div class="flex gap-4">

        <div>
            <div class="flex-auto md:flex md:justify-start md:items-center flex-col">
                <p-tree 
                    [value]="resourceItems" 
                    selectionMode="checkbox" 
                    [(selection)]="selectedRules"
                    styleClass="pop-data-selector-tree md:w-[30rem]"
                    [filter]="true" 
                    filterPlaceholder="Search and select">

                    <ng-template let-node pTemplate="CodedConcept">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="date">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="string">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="integer">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="number">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="default">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                </p-tree>
            </div>
        </div>
        @if (dataset) {
            <div class="pop-dataset-table">        
                <p-table 
                    [value]="dataset.hasValue() ? dataset.value() : emptyDatasetPlaceholder" 
                    [scrollable]="true"
                    [paginator]="true" 
                    [showCurrentPageReport]="true"
                    lazy="true"
                    [rows]="pagination().limit" 
                    [rowsPerPageOptions]="pageSizeChoices"
                    [totalRecords]="datasetSize()"
                    (onLazyLoad)="(pagination().limit !== $event.rows || pagination().offset !== $event.first) ? pagination.set({limit: $event.rows!, offset: $event.first!}) : ''"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                    scrollHeight="flex"
                    showGridlines>

                    <ng-template pTemplate="header">
                        <tr>                   
                            @if (dataset.isLoading()) {
                            <th><p-skeleton height="4rem" width="100%"/></th>
                            } @else {
                                @for (col of datasetColumns(); track $index; let first = $first) {
                                    <th pFrozenColumn [frozen]="first">{{ col | camelCaseToTitleCase }}</th>
                                }
                            }
                        </tr>
                    </ng-template>
                
                    <ng-template pTemplate="body" let-rowData>
                        <tr @fadeAnimation> 
                            @if (dataset.isLoading()) {
                                <td>
                                    <p-skeleton height="4rem" width="100%"/>
                                </td>
                            } @else {
                                @for (col of datasetColumns(); track $index; let first = $first) {
                                    <td pFrozenColumn [frozen]="first">
                                        @if (isNested(rowData[col])) {
                                            <!-- Check if the value is an object/array (nested structure) -->
                                            <div class="flex">
                                                <p-button 
                                                    [icon]="rowData[col].expanded ? 'pi pi-minus' : 'pi pi-plus'" 
                                                    [rounded]="true" 
                                                    [outlined]="true"
                                                    (onClick)="rowData[col].expanded = !rowData[col].expanded"
                                                    class="expand-nested-table-button"/>
                                                <div>
                                                    @if (rowData[col].expanded) {
                                                        <pop-nested-table [nestedData]="rowData[col]"></pop-nested-table>
                                                    } @else {
                                                        {{ rowData[col].length }} entries
                                                    }
                                                </div>
                                            </div>
                                        } @else {
                                            <!-- If it's a simple value, display normally -->
                                                @if (first) {
                                                <div class="flex gap-3">
                                                    <p-avatar size="normal" [style]="{'background': 'none', 'border': 'none', 'padding': '0'}">
                                                        <svg class="jdenticon" width="2rem" height="2rem" [data-jdenticon-value]="[rowData[col]]"></svg>
                                                    </p-avatar>
                                                    <div class="my-auto monospace">
                                                        {{ rowData[col] }}
                                                    </div>
                                                </div>
                                            } @else if (isArray(rowData[col])) {
                                                <ul class="list-none pl-0  overflow-y-auto max-h-15rem">
                                                    @for (value of rowData[col]; track $index;) {
                                                        <li class="mb-2">ðŸž„ {{ value || '-' }}</li>
                                                    }
                                                </ul>
                                                } @else {
                                                {{ rowData[col] || '-' }}
                                                }
                                        }                            
                                    </td>
                                }
                            }
                        </tr>                        
                    </ng-template>
                </p-table>
            </div>
        }
    </div>
</p-card>