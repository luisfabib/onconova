<p-card styleClass="h-[65rem]">
    <div class="flex mb-3">
        <p-fieldset legend="Dataset Defintion" styleClass="my-auto mr-3 pb-0" class="w-full">
            <div class="flex flex-wrap row-gap-3">
                <div class="flex flex-column mr-3 gap-3">
                    <div class="flex gap-1">
                        <p-button icon="pi pi-sync" [disabled]="processing()" label="Load Dataset" styleClass="load-dataset-button" severity="secondary" (onClick)="datasetSelect.toggle($event);"/>
                        <p-popover #datasetSelect>
                            <div class="flex flex-col gap-4">
                                <div>
                                    <span class="font-medium block mb-2">Project Datasets</span>
                                    <p-autocomplete 
                                        [(ngModel)]="selectedDataset"
                                        [dropdown]="true" 
                                        [suggestions]="projectDatasets.value() || []" 
                                        [forceSelection]="true"
                                        [completeOnFocus]="true"
                                        placeholder="Search or select a dataset"
                                        optionLabel="name"
                                        (completeMethod)="datasetTitleQuery.set($event.query); projectDatasets.reload()"/>
                                </div>
                            </div>
                        </p-popover>

                        <p-button icon="pi pi-eraser" [disabled]="processing()" label="Reset" severity="secondary" (onClick)="resetDataset()"/>
                    </div>
                    <p-button 
                        icon="pi pi-cloud-upload" 
                        [label]="dataset.value()?.id ? 'Update dataset' : 'Create dataset'" 
                        [disabled]="form.invalid 
                            || !datasetChanged()
                            || dataset.isLoading() 
                            || processing()" 
                        styleClass="dataset-save-button w-full" 
                        (onClick)="submitDataset()"/>
                </div>
                <form [formGroup]="form" class="dataset-metadata-form">
                    <div class="field">
                        <label class="form-label required mr-3">Title</label>
                        <input type="text" pInputText formControlName="title" [disabled]="processing()" />
                    </div>
                    <div class="field">
                            <label class="form-label required mr-3">Description</label>
                            <input type="text" pInputText class="w-20rem" formControlName="summary" [disabled]="processing()" />
                    </div>
                </form>
                <div class="ml-auto my-auto">
                    <p-menu #downloadMenu [model]="downloadMenuItems" [popup]="true" />
                    <p-button 
                        [icon]="currentUser().canExportData ? 'pi pi-download' : 'pi pi-lock'" 
                        label="Download Dataset" 
                        styleClass="dataset-download-button"
                        class="h-4rem flex mb-3"
                        (onClick)="downloadMenu.toggle($event)"
                        [disabled]="form.invalid 
                            || dataset.isLoading() 
                            || !dataset.value()?.id
                            || processing() 
                            || !currentUser().canExportData 
                            || datasetChanged()"/>
                </div>
            </div>
        </p-fieldset>
    </div>
    <div class="flex gap-4">

        <div>
            <div class="flex-auto md:flex md:justify-start md:items-center flex-col">
                <p-tree 
                    [value]="datasetTreeItems" 
                    selectionMode="checkbox" 
                    [(selection)]="selectedRules"
                    styleClass="pop-data-selector-tree md:w-[30rem]"
                    [filter]="true" 
                    filterPlaceholder="Search and select">

                    <ng-template let-node pTemplate="CodedConcept">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="date">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="string">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="integer">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="number">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                    <ng-template let-node pTemplate="default">
                        <span title="{{node.description}}">{{ node.label }}</span>
                    </ng-template>
                </p-tree>
            </div>
        </div>
        @if (datasetData) {
            <div class="pop-dataset-table">        
                <p-table 
                    [value]="datasetData.hasValue() ? datasetData.value() : emptyDatasetPlaceholder" 
                    [scrollable]="true"
                    [paginator]="true" 
                    [showCurrentPageReport]="true"
                    lazy="true"
                    [rows]="pagination().limit" 
                    [rowsPerPageOptions]="pageSizeChoices"
                    [totalRecords]="datasetDataSize()"
                    (onLazyLoad)="(pagination().limit !== $event.rows || pagination().offset !== $event.first) ? pagination.set({limit: $event.rows!, offset: $event.first!}) : ''"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                    scrollHeight="flex"
                    showGridlines>

                    <ng-template pTemplate="header">
                        <tr>                   
                            @if (datasetData.isLoading()) {
                                <th>
                                    <p-skeleton height="4rem" width="100%"/>
                                </th>
                            } @else {
                                @for (col of datasetDataColumns(); track $index; let first = $first) {
                                    @if (first) {
                                        <th class="p-table-frozen-column">Case</th>
                                    } @else {
                                        <th>{{ col | camelCaseToTitleCase }}</th>
                                    }
                                }
                            }
                        </tr>
                    </ng-template>
                
                    <ng-template pTemplate="body" let-rowData>
                        <tr @fadeAnimation> 
                            @if (datasetData.isLoading()) {
                                <td>
                                    <p-skeleton height="4rem" width="100%"/>
                                </td>
                            } @else {
                                @for (col of datasetDataColumns(); track $index; let first = $first) {
                                    <td [ngClass]="first ? 'p-table-frozen-column' : ''">
                                        @if (isNested(rowData[col])) {
                                            <!-- Check if the value is an object/array (nested structure) -->
                                            <div class="flex">
                                                <p-button 
                                                    [icon]="rowData[col].expanded ? 'pi pi-minus' : 'pi pi-plus'" 
                                                    [rounded]="true" 
                                                    [outlined]="true"
                                                    (onClick)="rowData[col].expanded = !rowData[col].expanded"
                                                    class="expand-nested-table-button"/>
                                                <div>
                                                    @if (rowData[col].expanded) {
                                                        <pop-nested-table [nestedData]="rowData[col]"></pop-nested-table>
                                                    } @else {
                                                        {{ rowData[col].length }} entries
                                                    }
                                                </div>
                                            </div>
                                        } @else {
                                            <!-- If it's a simple value, display normally -->
                                                @if (first) {
                                                <div class="flex gap-2">
                                                    <p-avatar size="normal" [style]="{'background': 'none', 'border': 'none', 'padding': '0'}">
                                                        <svg class="jdenticon" width="2rem" height="2rem" [data-jdenticon-value]="[rowData[col]]"></svg>
                                                    </p-avatar>
                                                    <div class="my-auto monospace">
                                                        {{ rowData[col] }}
                                                    </div>
                                                </div>
                                            } @else if (isArray(rowData[col])) {
                                                <ul class="list-none pl-0  overflow-y-auto max-h-15rem">
                                                    @for (value of rowData[col]; track $index;) {
                                                        <li class="mb-2">🞄 {{ value || '-' }}</li>
                                                    }
                                                </ul>
                                                } @else {
                                                {{ rowData[col] || '-' }}
                                                }
                                        }                            
                                    </td>
                                }
                            }
                        </tr>                        
                    </ng-template>
                </p-table>
            </div>
        }
    </div>
</p-card>


<p-confirmdialog maskStyleClass="confirmdialog">     
    <ng-template #headless let-onAccept="onAccept" let-onReject="onReject">
        <pop-export-confirm-dialog [onAccept]="onAccept" [onReject]="onReject"></pop-export-confirm-dialog>     
    </ng-template>
</p-confirmdialog>