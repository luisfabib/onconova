<div>
    @if (allowCollapse) {
      <a (click)="toggleCollapse()"
         [ngClass]="['q-arrow-icon-button', data.collapsed ? 'q-collapsed' : '']">
         <i class="q-icon pi pi-angle-right" style="line-height: 1.5rem; color: var(--p-button-text-secondary-color);"></i>
      </a>
    }
  
      <!-- Ruleset button group -->
    <div class="q-button-group q-right-align">
      <div class="flex">
        <p-buttongroup class="mr-3">
            <p-button label="Rule" icon="pi pi-plus" severity="secondary" (click)="addRule()" [disabled]="disabled" title="Add new rule to the ruleset"/>
            @if (allowRuleset) {
              <p-button label="Ruleset" icon="pi pi-folder-plus" severity="secondary" (click)="addRuleSet()" [disabled]="disabled" title="Add new sub-ruleset to the ruleset"/>
              <p-button label="Ruleset" icon="pi pi-trash" severity="secondary" (click)="removeRuleSet()" [disabled]="disabled" title="Delete the ruleset"/>
            }
        </p-buttongroup>
      </div>
    </div>
  
    <!-- Ruleset chain condition -->
    <p-selectbutton 
      [options]="[{label: 'AND', value: 'and'}, {label: 'OR', value: 'or'}]" 
      [disabled]="disabled"
      [(ngModel)]="data.condition"  
      [allowEmpty]="false"/>
  </div>
  
  <!-- Query tree -->
  <div #treeContainer (transitionend)="transitionEnd($event)" [ngClass]="['q-tree-container', data.collapsed ? 'q-collapsed' : '']">
    @if (data && data.rules) {
      <ul class="q-tree">
        @for (rule of data.rules; track $index; let i = $index; let last = $last) {
            @if ({
              ruleset: !!rule.rules,
              invalid: !config.allowEmptyRulesets && rule.rules && rule.rules.length === 0
            }; as local) {
              <li [ngClass]="['flex', 'q-row', 'q-connector', 'q-transition', local.ruleset ? 'q-ruleset' : 'q-rule', local.invalid ? 'q-invalid-ruleSet' : '']">
                @if (!local.ruleset) {
                  <!-- Rule button group -->
                  <div class="q-button-group q-right-align">
                    <div class="rule-filter-button-group">
                        <p-button 
                            icon="pi pi-plus" 
                            [rounded]="true" 
                            [text]="true" 
                            [disabled]="disabled"
                            severity="secondary" 
                            (click)="addRuleFilter(rule)"/>     
                        <p-button 
                            icon="pi pi-trash" 
                            [rounded]="true" 
                            [text]="true" 
                            [disabled]="disabled"
                            severity="secondary" 
                            (click)="removeRule(rule, data)"/>
                    </div>
                  </div>
                  
                  <!-- Entity selector -->
                  <div class="q-inline-block-display">
                      <div class="flex">
                        <div class="text-muted my-auto mr-2">Where</div>
                        <p-select 
                            [options]="entities" 
                            [(ngModel)]="rule.entity" 
                            [filter]="true" 
                            filterBy="name" 
                            [disabled]="disabled"
                            placeholder="Select an entity" 
                            optionValue="value" 
                            optionLabel="name" 
                            appendTo="body"/>
                    </div>
                  </div>
        
                  <ul class="pl-0">
                    @for (filter of rule.filters; track $index;) {
                      @let field = config.fields[filter.field];
                      <li class="flex gap-3 ml-0">          
                        <div class="text-muted my-auto ml-2" style="margin-right: -.5rem !important;">-</div>
                        <!-- Filter field selector -->
                        <p-select 
                          [options]="getFields(rule.entity)" 
                          [(ngModel)]="filter.field" 
                          (onChange)="filter.value = null;"
                          [filter]="true" 
                          filterBy="name" 
                          [disabled]="disabled"
                          placeholder="Select a field" 
                          optionValue="value" 
                          optionLabel="name" 
                          appendTo="body"/>
                        <!-- Tooltip for field description -->
                        @if (field.description) {
                          <p-avatar icon="pi pi-question" 
                            shape="circle" 
                            [style]="{'scale': '.65', 'margin-left': '-0.75rem', 'margin-right': '-0.5rem', 'margin-top': 'auto', 'margin-bottom': 'auto',}"
                            [pTooltip]="field.description" 
                            [tooltipOptions]="{tooltipStyleClass: 'q-field-description-tooltip'}" 
                            tooltipPosition="right"/>
                        }
  
                        <!-- Filter operator selector -->
                        <p-select 
                          [options]="field.operators | mapOperators" 
                          [(ngModel)]="filter.operator" 
                          [filter]="true" 
                          filterBy="name" 
                          (onChange)="filter.value = null;"
                          [disabled]="disabled"
                          placeholder="Select a filter" 
                          optionValue="value" 
                          optionLabel="name"  
                          appendTo="body"/>
                        
                        <!-- Filter value input -->
                        @switch (field.type) {
                          @case ('string') {
                            <input 
                              type="text" 
                              pInputText 
                              [(ngModel)]="filter.value" 
                              [disabled]="disabled"
                              placeholder="Enter a query"/>
                          }
                          @case ('Period') {
                            <pop-datepicker 
                              [(ngModel)]="filter.value"
                              [disabled]="disabled"
                              selectionMode="range"
                              placeholder="DD/MM/YYYY - DD/MM/YYYY"/>
                          }
                          @case ('date') {
                            <pop-datepicker 
                              [disabled]="disabled"
                              [(ngModel)]="filter.value"/>
                          }
                          @case ('Measure') {
                            <pop-measure-input
                              [(ngModel)]="filter.value" 
                              [measure]="field.measureType || ''"
                              [defaultUnit]="field.defaultUnit || ''"/>
                          }
                          @case ('boolean') {
                            <p-selectbutton 
                              [options]="[{label: 'Yes', value: true}, {label: 'No', value: false}]" 
                              [(ngModel)]="filter.value" 
                              [disabled]="disabled"/>
                          }
                          @case ('enum') {
                            @if (['AnyOfEnumFilter', 'NotAnyOfEnumFilter'].includes(rule.operator)) {
                                <p-multiselect 
                                    [options]="field.options" 
                                    [(ngModel)]="filter.value" 
                                    optionLabel="value" 
                                    optionValue="value"
                                    placeholder="Select one or more options" 
                                    display="chip"
                                    appendTo="body"/>
                            } @else {
                                <p-select 
                                    [options]="field.options" 
                                    [(ngModel)]="filter.value"
                                    [disabled]="disabled" 
                                    optionLabel="value"
                                    optionValue="value"
                                    placeholder="Select an option" 
                                    appendTo="body"/>
                            }
                          }
                          @case ('CodedConcept') {
                            <pop-concept-selector 
                              [(ngModel)]="filter.value" 
                              [terminology]="field.terminology || ''"
                              [returnCode]="true"
                              [disabled]="disabled"
                              [multiple]="['AnyOfConceptFilter', 'NotAnyOfConceptFilter'].includes(rule.operator)"
                              [showSynonyms]="false"/>
                          }
                          @case ('MultiCodedConcept') {
                            <pop-concept-selector 
                              [(ngModel)]="filter.value" 
                              [terminology]="field.terminology || ''"
                              [returnCode]="true"
                              [disabled]="disabled"
                              [multiple]="true"
                              [showSynonyms]="false"/>
                          }
                          @case ('number') {
                            @let requiresRange = ['NotBetweenFloatFilter', 'BetweenFloatFilter'].includes(rule.operator);
                            @if (requiresRange) {
                                <pop-range-input
                                    [(range)]="filter.value"
                                    [disabled]="disabled"/>
                            } @else {
                                <p-inputnumber 
                                    [(ngModel)]="filter.value" 
                                    [disabled]="disabled"
                                    placeholder="Enter a value" 
                                    useGrouping="false" 
                                    mode="decimal" 
                                    [minFractionDigits]="1" 
                                    [maxFractionDigits]="3" 
                                    locale="en-US"/>
                            }    
                          }
                          @case ('integer') {
                            @let requiresRange = ['NotBetweenIntegerFilter', 'BetweenIntegerFilter'].includes(rule.operator);
                            @if (requiresRange) {
                                <pop-range-input
                                    [(range)]="filter.value"
                                    [disabled]="disabled"/>
                            } @else {
                                <p-inputnumber 
                                    [(ngModel)]="filter.value" 
                                    [disabled]="disabled"
                                    placeholder="Enter a value" 
                                    useGrouping="false"/>
                            }    
                          }
                        }
                      </li>
                    }
                  </ul>
    
                  
                } @else {
                  <pop-cohort-query-builder
                    [data]="rule"
                    [disabled]="disabled"
                    [parentTouchedCallback]="parentTouchedCallback || onTouchedCallback"
                    [parentChangeCallback]="parentChangeCallback || onChangeCallback"
                    [parentValue]="data"
                    [allowRuleset]="allowRuleset"
                    [allowCollapse]="allowCollapse"
                    [emptyMessage]="emptyMessage"/>
                }
              </li>
              @if (local.invalid) {
                <div>
                  <p-message [text]="emptyMessage" severity="error"/>
                </div>
              }
            }
        }
      </ul>
    }
  </div>
  