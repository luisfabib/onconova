<p-fluid>
    <form  [formGroup]="form" (ngSubmit)="onSave()">

        <div class="flex flex-wrap">

            <div class="field">
                <label class="form-label required">Treatment period</label>
                <pop-datepicker 
                    formControlName="period"
                    selectionMode="range"
                    placeholder="DD/MM/YYYY - DD/MM/YYYY"
                />
                <pop-form-control-error controlName="period"></pop-form-control-error>
            </div>
        </div>

        <div class="field">
            <label class="form-label required">Neoplastic entities targeted</label>
            <pop-multi-reference-select 
            formControlName="targetedEntities"
            [options]="relatedEntities"/>
            <pop-form-control-error controlName="targetedEntities"></pop-form-control-error>
        </div>

        <div class="field">
            <label class="form-label required">Intent</label>
            <pop-radio-select  
            formControlName="intent"
            [choices]="intentChoices"
            class="flex flex-wrap gap-4"/>
            <pop-form-control-error controlName="intent"></pop-form-control-error>
        </div>


        <div class="field">
            <label class="form-label required">Total sessions</label>
            <p-inputnumber 
            formControlName="sessions"
            placeholder="Enter value" 
            useGrouping="false"
            suffix=" session(s)"/>
            <pop-form-control-error controlName="sessions"></pop-form-control-error>
        </div>
        
        <div class="field">
            <label class="form-label">Termination reason</label>
            <pop-concept-selector 
                formControlName="terminationReason"
                terminology="TreatmentTerminationReason"
                [showSynonyms]="false"/>
            <pop-form-control-error controlName="terminationReason"></pop-form-control-error>
        </div>

        <div formArrayName="dosages">
            @for (control of dosageFormArray.controls; track $index; let i = $index) {
                <p-fieldset legend="Dosage" [toggleable]="false" [formGroupName]="i" [collapsed]="false">
                    <p-button icon="pi pi-times" (click)="removeDosage(i)" class="subform-remove-button"/>
                    <div class="mt-3">
                        <div class="field">
                            <label class="form-label required">Irradiated bodysite</label>
                            <pop-concept-selector 
                                formControlName="irradiatedVolume"
                                terminology="RadiotherapyTreatmentLocation"
                                [showSynonyms]="true"/>
                        </div>
                    </div>
                    <div class="field">
                        <label class="form-label required">Fractions delivered to the bodysite</label>
                        <p-inputnumber 
                            formControlName="fractions"
                            placeholder="Enter value" 
                            useGrouping="false"
                            suffix=" fraction(s)"/>
                    </div>
                    <div class="field">
                        <label class="form-label required">Total radiation dose delivered</label>
                        <pop-measure-input 
                            formControlName="dose"
                            measure="RadiationDose"/>
                    </div>
                </p-fieldset>
            }
            <p-button icon="pi pi-plus" label="Add dosage" (click)="addDosage()" class="subform-add-button"/>
        </div>
        

        <div formArrayName="settings">
            @for (control of settingsFormArray.controls; track $index; let i = $index) {
                <p-fieldset  legend="Modality & Technique" [toggleable]="false" [formGroupName]="i" [collapsed]="false">
                    <p-button icon="pi pi-times" (click)="removeSetting(i)" class="subform-remove-button"/>
                    <div class="mt-3">
                        <div class="field">
                            <label class="form-label required">Modality</label>
                            <pop-concept-selector 
                                formControlName="modality"
                                terminology="RadiotherapyModality"
                                [showSynonyms]="true"/>
                        </div>
                        <div class="field">
                            <label class="form-label required">Technique</label>
                            <pop-concept-selector 
                                formControlName="technique"
                                terminology="RadiotherapyTechnique"
                                [showSynonyms]="true"/>
                        </div>
                    </div>
                </p-fieldset>
            }
            <p-button icon="pi pi-plus" label="Add modality & technique" (click)="addSetting()" class="subform-add-button"/>
        </div>

        <p-button 
            type="submit" 
            label="Save" 
            styleClass="w-full p-3 mt-4"  
            [loading]="loading"
            [disabled]="form.invalid" />
            
    </form>
</p-fluid>