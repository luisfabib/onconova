<p-fluid>
    <form  [formGroup]="form" (ngSubmit)="submitFormData()">


        <div class="field">
            <label class="form-label required">Treatment period</label>
            <pop-datepicker 
                formControlName="period"
                selectionMode="range"
                placeholder="DD/MM/YYYY - DD/MM/YYYY"
            />
            <pop-form-control-error controlName="period"></pop-form-control-error>
        </div>


        <div class="field">
            <label class="form-label required">Cycles</label>
            <p-inputnumber 
            formControlName="cycles"
            placeholder="Enter value" 
            useGrouping="false"
            suffix=" cycle(s)"/>
            <pop-form-control-error controlName="cycles"></pop-form-control-error>
        </div>

        <div class="field">
            <label class="form-label required">Neoplastic entities targeted</label>
            <pop-multi-reference-select 
            formControlName="targetedEntities"
            [options]="relatedEntities.value() || []"/>
            <pop-form-control-error controlName="targetedEntities"></pop-form-control-error>
        </div>

        <div class="field">
            <label class="form-label required">Medication(s)</label>
            <pop-concept-selector 
                formControlName="drugs"
                terminology="AntineoplasticAgent"
                [showSynonyms]="true"
                [multiple]="true"/>
            <pop-form-control-error controlName="drugs"></pop-form-control-error>
        </div>

        <div class="field">
            <label class="form-label required">Intent</label>
            <p-selectbutton 
                formControlName="intent"
                [options]="intentChoices"
                class="flex"/>
            <pop-form-control-error controlName="intent"></pop-form-control-error>
        </div>

        <div class="field">
            <label class="form-label required">Therapeutic role</label>
            <p-selectbutton
                formControlName="isAdjunctive"
                [options]="roleChoices"
                class="flex"/>
            <pop-form-control-error controlName="isAdjunctive"></pop-form-control-error>
        </div>

        @if (form.value.isAdjunctive) {
            <div class="field">
                <label class="form-label required">Adjunctive role</label>
                <pop-concept-selector 
                    formControlName="adjunctiveRole"
                    terminology="AdjunctiveTherapyRole"
                    [showSynonyms]="false"/>
                <pop-form-control-error controlName="adjunctiveRole"></pop-form-control-error>
            </div>    
        }

        <div class="field">
            <label class="form-label">Termination reason</label>
            <pop-concept-selector 
                formControlName="terminationReason"
                terminology="TreatmentTerminationReason"
                [showSynonyms]="false"/>
            <pop-form-control-error controlName="terminationReason"></pop-form-control-error>
        </div>

        <div formArrayName="medications">
            @for (control of form.controls['medications'].controls; track $index; let i = $index) {
                <p-fieldset  [toggleable]="true" [formGroupName]="i" [collapsed]="true">
                    <ng-template #header>
                        {{control.value.drug!.display}} - Administration details
                    </ng-template>
                    <div class="mt-3">
                        <div class="field">
                            <label class="form-label">Administration route</label>
                            <pop-concept-selector 
                                formControlName="route"
                                terminology="DosageRoute"
                                [showSynonyms]="true"/>
                        </div>
                        <div class="field">
                            <label class="form-label required">Dosage type</label>
                            <pop-radio-select  
                            formControlName="dosageType"
                            [choices]="dosageTypeChoices"
                            class="flex flex-wrap gap-4"/>
                        </div>
                        <div class="field">
                            <label class="form-label">Dosage</label>
                            @switch (control.value.dosageType) {
                                @case ('Mass') {
                                    <pop-measure-input formControlName="dosageMass" measure="Mass"/>
                                }
                                @case ('MassConcentration') {
                                    <pop-measure-input formControlName="dosageMassConcentration" measure="MassConcentration"/>
                                }
                                @case ('Volume') {
                                    <pop-measure-input formControlName="dosageVolume" measure="Volume"/>
                                }
                                @case ('MassPerSurface') {
                                    <pop-measure-input formControlName="dosageMassSurface" measure="MassPerArea"/>
                                }
                                @default {
                                    <div class="text-muted">Select a dosage type first</div>
                                }
                            }
                        </div>
                        <div class="field">
                            <label class="form-label">Dosage rate</label>
                            @switch (control.value.dosageType) {
                                @case ('Mass') {
                                    <pop-measure-input formControlName="dosageRateMass" measure="MassPerTime"/>
                                }
                                @case ('MassConcentration') {
                                    <pop-measure-input formControlName="dosageRateMassConcentration" measure="MassConcentrationPerTime"/>
                                }
                                @case ('Volume') {
                                    <pop-measure-input formControlName="dosageRateVolume" measure="VolumePerTime"/>
                                }
                                @case ('MassPerSurface') {
                                    <pop-measure-input formControlName="dosageRateMassSurface" measure="MassPerAreaPerTime"/>
                                }
                                @default {
                                    <div class="text-muted">Select a dosage type first</div>
                                }
                            }
                        </div>
                    </div>
                </p-fieldset>
            }
        </div>
        
        <p-button 
            type="submit" 
            label="Save" 
            styleClass="w-full p-3 mt-4"  
            [loading]="isSaving()"
            [disabled]="form.invalid" />
            
    </form>
</p-fluid>