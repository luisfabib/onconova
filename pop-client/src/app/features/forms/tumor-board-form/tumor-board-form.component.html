<p-fluid>
    <form  [formGroup]="form" (ngSubmit)="onSave()">

        <div class="field">
            <label class="form-label required">Tumor board specialty</label>
            <p-select  
                formControlName="category"
                [options]="tumorBoardSpecialtyChoices"
                optionLabel="name"
                placeholder="Select a specialty"
                appendTo="body" 
                optionValue="value"/>
            <pop-form-control-error controlName="category"></pop-form-control-error>
        </div>

        <div class="field">
            <label for="date" class="form-label required">Date of the tumor board</label>
            <pop-datepicker 
                formControlName="date"
            />
            <pop-form-control-error controlName="date"></pop-form-control-error>
        </div>

        @let relatedEntities = relatedEntities$ | async;
        <div class="field">
            <label class="form-label required">Neoplastic entities that were focus of the board</label>
            <pop-multi-reference-select 
            formControlName="relatedEntities"
            [options]="relatedEntities || []"/>
            <pop-form-control-error controlName="relatedEntities"></pop-form-control-error>
        </div>


        <div class="field">
            <label class="form-label">Board recommendation(s)</label>
            <pop-concept-selector 
                formControlName="recommendations"
                [terminology]="form.value.category == TumorBoardSpecialties.Molecular ? 'MolecularTumorBoardRecommendation' :'TumorBoardRecommendation'"
                [showSynonyms]="true"
                [multiple]="true"/>
            <pop-form-control-error controlName="recommendations"></pop-form-control-error>
        </div>
        
        @switch (form.value.category) {
            @case (TumorBoardSpecialties.Molecular) {
                @let relatedReports = relatedReports$ | async;
                <div class="field">
                    <label class="form-label required">Reviewed genetic test(s)</label>
                    <p-multiselect  
                    formControlName="reviewedReports"
                    [options]="relatedReports || []"
                    optionLabel="name"
                    optionValue="value"
                    placeholder="Select genetic tests"
                    class="flex flex-wrap gap-4"/>
                    <pop-form-control-error controlName="reviewedReports"></pop-form-control-error>
                </div>   
    
                <div class="field">
                    <label class="form-label required">Was a molecular comparison conducted?</label>
                    <pop-radio-select  
                    formControlName="conductedMolecularComparison"
                    [choices]="YesNoChoices"
                    class="flex flex-wrap gap-4"/>
                    <pop-form-control-error controlName="conductedMolecularComparison"></pop-form-control-error>
                </div>        
    
                @if (form.value.conductedMolecularComparison) {
                    <div class="field ml-3">
                        <label class="form-label required">Was it successful?</label>
                        <pop-radio-select  
                        formControlName="succeededMolecularComparison"
                        [choices]="YesNoChoices"
                        class="flex flex-wrap gap-4"/>
                        <pop-form-control-error controlName="succeededMolecularComparison"></pop-form-control-error>
                    </div>      
                    @if (form.value.succeededMolecularComparison) {
                        @let relatedPrimaryEntities = relatedPrimaryEntities$ | async;
                        <div class="field ml-3">
                            <label for="relatedPrimary" class="form-label required">Matching primary neoplastic entity</label>
                            <p-select 
                            [options]="relatedPrimaryEntities || []" 
                            formControlName="molecularComparisonMatch"
                            optionLabel="description" 
                            optionValue="id"
                            placeholder="Select an option" />
                            <pop-form-control-error controlName="molecularComparisonMatch"></pop-form-control-error>
                        </div>
                    }
                }
            
                <div class="field">
                    <label class="form-label required">Was a CUP characterization conducted</label>
                    <pop-radio-select  
                    formControlName="conductedCupCharacterization"
                    [choices]="YesNoChoices"
                    class="flex flex-wrap gap-4"/>
                    <pop-form-control-error controlName="conductedCupCharacterization"></pop-form-control-error>
                </div>        
                
                @if (form.value.conductedCupCharacterization) {
                    <div class="field ml-3">
                        <label class="form-label required">Was a it succesful?</label>
                        <pop-radio-select  
                        formControlName="characterizedCup"
                        [choices]="YesNoChoices"
                        class="flex flex-wrap gap-4"/>
                        <pop-form-control-error controlName="characterizedCup"></pop-form-control-error>
                    </div>        
                }

                <div formArrayName="therapeuticRecommendations">
                    @let relatedEvidence = relatedEvidence$ | async;
                    @for (control of molecularTherapeuticRecommendationsFormArray.controls; track $index; let i = $index) {
                        <p-fieldset  legend="Molecular therapeutic recommendation" [toggleable]="false" [formGroupName]="i" [collapsed]="false">
                            <p-button icon="pi pi-times" (click)="removeMolecularTherapeuticRecommendation(i)" class="subform-remove-button"/>
                            <div class="mt-3">
                                <div class="field">
                                    <label class="form-label required">Type of recommendation</label>
                                    <pop-radio-select  
                                    formControlName="recommendationType"
                                    [choices]="TherapeuticRecommendationTypeChoices"
                                    class="flex flex-wrap gap-4"/>
                                </div>  
                                <div class="field">
                                    <label class="form-label required">Based on which evidence?</label>
                                    <pop-multi-reference-select 
                                    formControlName="supportingEntries"
                                    [options]="relatedEvidence || []"/>
                                </div>
                                @switch (control.value.recommendationType) {
                                    @case (TherapeuticRecommendationType.ClinicalTrial) {
                                        <div class="field">
                                            <label class="form-label required">Clinical Trial</label>
                                            <p-inputmask 
                                                mask="NCT99999999" 
                                                formControlName="clinicalTrial"
                                                placeholder="NCT12345678" />
                                        </div>                                        
                                    }
                                    @case (TherapeuticRecommendationType.Drugs) {
                                        <div class="field">
                                            <label class="form-label required">Medication(s)</label>
                                            <pop-concept-selector 
                                                formControlName="drugs"
                                                terminology="AntineoplasticAgent"
                                                [showSynonyms]="true"
                                                [multiple]="true"/>
                                        </div>
                                        <div class="field">
                                            <label class="form-label required">Expected effect</label>
                                            <pop-concept-selector 
                                                formControlName="expectedEffect"
                                                terminology="ExpectedDrugAction"
                                                [showSynonyms]="false"/>
                                        </div>
                                        <div class="field">
                                            <label class="form-label required">Adherence to clinical practices</label>
                                            <pop-radio-select  
                                            formControlName="withinSoc"
                                            [choices]="YesNoChoices"
                                            class="flex flex-wrap gap-4"/>
                                        </div>  
                                        <div class="field">
                                            <label class="form-label required">Adherence to medication label</label>
                                            <pop-radio-select  
                                            formControlName="offLabelUse"
                                            [choices]="YesNoChoices"
                                            class="flex flex-wrap gap-4"/>
                                        </div>                                      
                                    }
                                }
                            </div>
                        </p-fieldset>
                    }
                    <p-button icon="pi pi-plus" label="Add therapeutic recommendation" (click)="addMolecularTherapeuticRecommendation()" class="subform-add-button"/>
                </div>
            }
        }
        
        <p-button 
            type="submit" 
            label="Save" 
            styleClass="w-full p-3 mt-4"  
            [loading]="loading"
            [disabled]="form.invalid" />
            
    </form>
</p-fluid>