<h3 class="mb-1">User Administration</h3>
<div class="text-muted">In this page you can manage the platform's users and add/authorize new users.</div>
{{ queryFilters | json}}
<p-card styleClass="mt-4">
    <div class="flex mb-2">
    </div>
    <p-table             
        [value]="users.value() || []"
        [paginator]="true" 
        [showCurrentPageReport]="true"
        lazy="true"
        [rows]="pagination().limit" 
        [rowsPerPageOptions]="pageSizeChoices"
        [totalRecords]="totalUsers()"
        (onLazyLoad)="pagination.set({limit: $event.rows || 10, offset: $event.first || 0})"
        (onFilter)="applyFilters($event)"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries">>
        <ng-template #header>
            <tr>
                <th class="w-5rem"></th>
                <th>Username</th>
                <th>Name</th>
                <th>Access level & Role</th>
                <th>Email</th>
                <th>Provider</th>
                <th>Last login</th>
            </tr>
            <tr>
                <th>
                    <p-button label="Add user" icon="pi pi-plus" (onClick)="openUserForm({})" severity="primary" [style]="{'white-space': 'nowrap'}"/>
                </th>
                <th>
                    <p-columnFilter
                        type="text"
                        field="username"
                        matchMode="contains"
                        [showButtons]="true"
                        [matchModeOptions]="[{label:'contains', value:'contains'}]"
                        placeholder="Search by username"
                    ></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter
                        type="text"
                        field="lastName"
                        matchMode="contains"
                        [matchModeOptions]="[{label:'contains', value:'contains'}]"
                        placeholder="Search by name"
                    ></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter
                        type="text"
                        field="role"
                        matchMode="contains"
                        [matchModeOptions]="[{label:'contains', value:'contains'}]"
                        placeholder="Search by role"
                    ></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter
                        type="text"
                        field="email"
                        matchMode="contains"
                        [matchModeOptions]="[{label:'contains', value:'contains'}]"
                        placeholder="Search by email"
                    ></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter
                        type="text"
                        field="provider"
                        matchMode="contains"
                        [matchModeOptions]="[{label:'contains', value:'contains'}]"
                        placeholder="Search by provider"
                    ></p-columnFilter>
                </th>
                <th></th>
        </ng-template>
        <ng-template #body let-user>
            <tr>
                @if (users.isLoading()) {
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                    <td><p-skeleton height="2rem" width="100%"/></td>
                } @else {
                    <td class="flex gap-2">
                        <p-button title="Update user information" icon="pi pi-pencil" (click)="openUserForm(user)" severity="primary" rounded outlined />
                        @if (!user.isProvided) {
                            <p-button title="Reset user password" icon="pi pi-key" (click)="openPasswordResetForm(true, user)" severity="danger" rounded outlined />
                        }
                    </td>
                    <td class="text-monospace">{{ user.username }}</td>
                    <td>{{ user.lastName }}, {{ user.firstName }}</td>
                    <td>{{ user.accessLevel }} - {{ user.role }}</td>
                    <td>{{ user.email }}</td>
                    <td><i class="pi pi-{{ user.provider }}"></i> {{ user.provider | titlecase }}</td>
                    <td>{{ user.lastLogin | date: 'medium'}}</td>
                }
            </tr>
        </ng-template>
    </p-table>
</p-card>
