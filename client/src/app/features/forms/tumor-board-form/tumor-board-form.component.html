<p-fluid>
    <form  [formGroup]="form" (ngSubmit)="submitFormData()">

        <div class="field">
            <label class="form-label required">Tumor board specialty</label>
            <p-select  
                formControlName="category"
                [options]="tumorBoardSpecialtyChoices"
                optionLabel="name"
                placeholder="Select a specialty"
                appendTo="body" 
                optionValue="value"/>
            <onconova-form-control-error controlName="category"></onconova-form-control-error>
        </div>

        <div class="field">
            <label for="date" class="form-label required">Date of the tumor board</label>
            <onconova-datepicker 
                formControlName="date"
            />
            <onconova-form-control-error controlName="date"></onconova-form-control-error>
        </div>

        <div class="field">
            <label class="form-label required">Neoplastic entities that were focus of the board</label>
            <onconova-multi-reference-select 
            formControlName="relatedEntities"
            [options]="relatedEntities.value() || []"/>
            <onconova-form-control-error controlName="relatedEntities"></onconova-form-control-error>
        </div>

        
        <div class="field">
            <label class="form-label">General board recommendation(s)</label>
            <onconova-concept-selector 
                formControlName="recommendations"
                [terminology]="form.value.category == 'molecular' ? 'MolecularTumorBoardRecommendation' :'TumorBoardRecommendation'"
                [showSynonyms]="true"
                [multiple]="true"/>
            <onconova-form-control-error controlName="recommendations"></onconova-form-control-error>
        </div>
        
        @switch (form.value.category) {
            @case ('molecular') {
                <div formGroupName="molecularBoard">
                    <div class="field">
                        <label class="form-label required">Reviewed genetic test(s)</label>
                        <p-multiselect  
                        formControlName="reviewedReports"
                        [options]="relatedReports.value() || []"
                        optionLabel="name"
                        optionValue="value"
                        placeholder="Select genetic tests"
                        class="flex flex-wrap gap-4"/>
                    </div>   
        
                    <div class="field">
                        <label class="form-label required">Was a molecular comparison conducted?</label>
                        <onconova-radio-select  
                        formControlName="conductedMolecularComparison"
                        [choices]="YesNoChoices"
                        class="flex flex-wrap gap-4"/>
                    </div>        
        
                    @if (form.value.molecularBoard!.conductedMolecularComparison) {
                        <div class="field ml-3">
                            <label class="form-label required">Was it successful?</label>
                            <onconova-radio-select  
                            formControlName="succeededMolecularComparison"
                            [choices]="YesNoChoices"
                            class="flex flex-wrap gap-4"/>
                        </div>      
                        @if (form.value.molecularBoard!.succeededMolecularComparison) {
                            <div class="field ml-3">
                                <label for="relatedPrimary" class="form-label required">Matching primary neoplastic entity</label>
                                <p-select 
                                [options]="relatedPrimaryEntities.value() || []" 
                                formControlName="molecularComparisonMatch"
                                optionLabel="description" 
                                optionValue="id"
                                placeholder="Select an option" />
                            </div>
                        }
                    }
                
                    <div class="field">
                        <label class="form-label required">Was a CUP characterization conducted</label>
                        <onconova-radio-select  
                        formControlName="conductedCupCharacterization"
                        [choices]="YesNoChoices"
                        class="flex flex-wrap gap-4"/>
                    </div>        
                    
                    @if (form.value.molecularBoard!.conductedCupCharacterization) {
                        <div class="field ml-3">
                            <label class="form-label required">Was a it succesful?</label>
                            <onconova-radio-select  
                            formControlName="characterizedCup"
                            [choices]="YesNoChoices"
                            class="flex flex-wrap gap-4"/>
                        </div>        
                    }

                    <div formArrayName="therapeuticRecommendations">
                        @for (control of form.controls['molecularBoard'].controls['therapeuticRecommendations'].controls; track $index; let i = $index) {
                            <p-fieldset  legend="Molecular therapeutic recommendation" [toggleable]="false" [formGroupName]="i" [collapsed]="false">
                                <p-button icon="pi pi-times" (click)="removeMolecularTherapeuticRecommendation(i)" class="subform-remove-button"/>
                                <div class="mt-3">
                                    <div class="field">
                                        <label class="form-label required">Type of recommendation</label>
                                        <onconova-radio-select  
                                        formControlName="recommendationType"
                                        [choices]="TherapeuticRecommendationTypeChoices"
                                        class="flex flex-wrap gap-4"/>
                                    </div>  
                                    <div class="field">
                                        <label class="form-label required">Based on which evidence?</label>
                                        <onconova-multi-reference-select 
                                        formControlName="supportingEntries"
                                        [options]="molecularEvidence.value() || []"/>
                                    </div>
                                    @switch (control.value.recommendationType) {
                                        @case (TherapeuticRecommendationType.ClinicalTrial) {
                                            <div class="field">
                                                <label class="form-label required">Clinical Trial</label>
                                                <p-inputmask 
                                                    mask="NCT99999999" 
                                                    formControlName="clinicalTrial"
                                                    placeholder="NCT12345678" />
                                            </div>                                        
                                        }
                                        @case (TherapeuticRecommendationType.Drugs) {
                                            <div class="field">
                                                <label class="form-label required">Medication(s)</label>
                                                <onconova-concept-selector 
                                                    formControlName="drugs"
                                                    terminology="AntineoplasticAgent"
                                                    [showSynonyms]="true"
                                                    [multiple]="true"/>
                                            </div>
                                            <div class="field">
                                                <label class="form-label required">Expected effect</label>
                                                <onconova-concept-selector 
                                                    formControlName="expectedEffect"
                                                    terminology="ExpectedDrugAction"
                                                    [showSynonyms]="false"/>
                                            </div>
                                            <div class="field">
                                                <label class="form-label required">Adherence to clinical practices</label>
                                                <onconova-radio-select  
                                                formControlName="withinSoc"
                                                [choices]="YesNoChoices"
                                                class="flex flex-wrap gap-4"/>
                                            </div>  
                                            <div class="field">
                                                <label class="form-label required">Adherence to medication label</label>
                                                <onconova-radio-select  
                                                formControlName="offLabelUse"
                                                [choices]="YesNoChoices"
                                                class="flex flex-wrap gap-4"/>
                                            </div>                                      
                                        }
                                    }
                                </div>
                            </p-fieldset>
                        }
                        <p-button icon="pi pi-plus" label="Add therapeutic recommendation" (click)="addMolecularTherapeuticRecommendation()" class="subform-add-button"/>
                    </div>
                </div>
            }
        }
        
        <p-button 
            type="submit" 
            label="Save" 
            styleClass="w-full p-3 mt-4"  
            [loading]="isSaving()"
            [disabled]="form.invalid" />
            
    </form>
</p-fluid>