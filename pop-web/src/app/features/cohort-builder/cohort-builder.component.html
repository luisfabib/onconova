

<div class="mb-3">
    <p-button label="Return" severity="secondary" icon="pi pi-chevron-left" (click)="location.back()"/>
</div>

<form *ngIf="!initloading" [formGroup]="cohortControl" (ngSubmit)="submitCohort()" class="cohort-manager">

<div class="flex my-3 mt-5">
    <div class="header" >
        <div class="mb-1 text-muted">Cohort</div>
        <div>
            <div *ngIf="!editCohortName"  style="font-size: 2rem;">
                {{ cohortControl.value.name }}
                <i class="pi pi-pencil" (click)="editCohortName = true"></i>
            </div>
            <ng-container *ngIf="editCohortName">
                <input type="text" pInputText formControlName="name" class="mr-2"/>
                <i class="pi pi-check" (click)="editCohortName = false"></i>
            </ng-container>
        </div>
        <div class="flex mt-2">
            <div class="text-md mr-2">
                <p-chip *ngIf="cohort.isPublic" label="Public" icon="pi pi-lock-open" class="is-public-chip"/>
                <p-chip *ngIf="!cohort.isPublic" label="Private" icon="pi pi-unlock" class="is-public-chip"/>
            </div>
            <div class="mt-2 text-muted"><i class="pi pi-history"></i> Last updated: {{cohort.updatedAt | date }}</div>
        </div>
    </div>
</div>

<div class="flex flex-wrap gap-4 mb-3">

    <p-card class="flex" styleClass="border border-surface shadow-none">
        <div class="flex justify-between gap-8">
            <div class="flex flex gap-2">

                <div class="mr-1 my-auto">
                    <p-avatar class="cohort-statistics-avatar mr-2" size="large" shape="circle" [style]="{ 'background-color': 'var(--p-primary-color)', color: '#ffffff'}">
                        <lucide-angular class="cohort-search-item-icon" [img]="populationIcon"></lucide-angular>
                    </p-avatar>
                </div>

                <div class="flex flex-column">
                    <div class="text-muted mb-1">Population</div>
                    <div class="flex">
                        <div *ngIf="cohort">
                            <span class="font-bold text-lg">{{ cohort.population }}</span> cases
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </p-card>

    <p-card class="flex" styleClass="border border-surface shadow-none">
        <div class="flex justify-between gap-8">
            <div class="flex flex gap-2">
                
                <div class="mr-1 my-auto">
                    <p-avatar class="cohort-statistics-avatar mr-2" size="large" shape="circle" [style]="{ 'background-color': 'var(--p-primary-color)', color: '#ffffff'}">
                        <lucide-angular class="cohort-search-item-icon" [img]="ageIcon"></lucide-angular>
                    </p-avatar>
                </div>

                <div class="flex flex-column">
                    <div class="text-muted mb-1">Average age</div>
                    <div class="flex">
                        <div *ngIf="cohortStatistics">
                            <span class="font-bold text-lg">{{ cohortStatistics.ageAverage || '-' }}</span> 
                            <span *ngIf="cohortStatistics.ageStdDev !== null" class=""> (±{{ cohortStatistics.ageStdDev}})</span>
                            years
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </p-card>


    <p-card class="flex" styleClass="border border-surface shadow-none">
        <div class="flex justify-between gap-8">
            <div class="flex flex gap-2">

                <div class="mr-1 my-auto">
                    <p-avatar class="cohort-statistics-avatar mr-2" size="large" shape="circle" [style]="{ 'background-color': 'var(--p-primary-color)', color: '#ffffff'}">
                        <lucide-angular class="cohort-search-item-icon" [img]="completionIcon"></lucide-angular>
                    </p-avatar>
                </div>

                <div class="flex flex-column">
                    <div class="text-muted mb-1">Average data completion</div>
                    <div class="flex">
                        <div *ngIf="cohortStatistics">
                            <span class="font-bold text-lg">{{ cohortStatistics.dataCompletionAverage ?? '-' }}%</span>
                            <span *ngIf="cohortStatistics.dataCompletionStdDev !== null" class=""> (±{{ cohortStatistics.dataCompletionStdDev}}%)</span> data categories
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </p-card>


</div>



<h4 class="text-muted">Definition</h4>

<div class="flex flex-column gap-3">

    <p-panel class="cohort-criteria-panel" [toggleable]="true" [collapsed]="cohortControl.value.includeCriteria === null">    
        <ng-template #header>
            <div class="flex gap-2 align-items-center">
                <i class="pi pi-thumbs-up"></i>
                <div class="font-bold">Inclusion criteria</div>
                <p-chip label="{{ cohortControl.value.includeCriteria ? cohortControl.value.includeCriteria.rules.length : 0 }} rules" class="p-1"/>
            </div>
        </ng-template>
        <pop-cohort-query-builder formControlName="includeCriteria" />
    </p-panel>

    <p-panel class="cohort-criteria-panel" [toggleable]="true" [collapsed]="cohortControl.value.excludeCriteria === null">    
        <ng-template #header>
            <div class="flex gap-2 align-items-center">
                <i class="pi pi-thumbs-down"></i>
                <div class="font-bold">Exclusion criteria</div>
                <p-chip label="{{ cohortControl.value.excludeCriteria ? cohortControl.value.excludeCriteria.rules.length : 0 }} rules" class="p-1"/>
            </div>
        </ng-template>
        <pop-cohort-query-builder formControlName="excludeCriteria" />
    </p-panel>

</div>


<div class="mt-3">
    <p-button 
    type="submit" 
    icon="pi pi-sync"
    label="Update Cohort" 
    styleClass="w-full p-3 mt-2"  
    [loading]="loading"
    [disabled]="cohortControl.invalid" />
</div>

<h4 class="text-muted">Cohort Composition</h4>

<div>
    <p-dataView 
        [value]="cohortCases || undefined"
        [paginator]="true" 
        [rows]="pageSize" 
        layout="grid"
        sortField="createdAt"
        lazy="true"
        [totalRecords]="cohort.population"
        (onLazyLoad)="setPaginationAndRefresh($event)"
        class="no-background">

        <ng-template #grid let-cases>
            <div class="grid mt-3">
                <div class="col p-2"*ngFor="let case of cases; let first = first" >
                    <pop-case-search-item 
                    [case]="case"/>
                </div>
            </div>
        </ng-template>
    </p-dataView>
</div>



</form>