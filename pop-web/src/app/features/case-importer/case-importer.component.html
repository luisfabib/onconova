
<h1>Case Import Interface</h1>

<p class="w-50">
Import cases quickly and easily with our intuitive interface. Simply select the file you want to import,
choose your options, and let the system do the rest. Track the progress of your import and get notified when it's complete.
</p>

<div class="card flex py-4 header" style="background: var(--p-content-background); color: var(--p-text-color)">
    <p-stepper [value]="1" [linear]="true">
        <p-step-item [value]="1">
            <p-step><span class="text-lg font-semibold">Select the data format</span></p-step>
            <p-step-panel>
                <ng-template #content let-activateCallback="activateCallback">
                    <div class="flex flex-col h-48">
                        <div class="flex flex-column gap-2">
                            <h6 class="text-muted font-semibold mb-1">POP JSON Format</h6> 
                            <p>
                                Select this option if you have a file in our internal POP JSON format. This format is specific to our system and is used for
                                 storing and processing cases. If you've exported cases from our system previously, they'll be in POP JSON format. You can
                                import these files directly into the system without needing to convert them.
                            </p>
                            <h6 class="text-muted font-semibold my-1">FHIR JSON Format</h6> 
                            <p>
                                Select this option if you have a file in FHIR (Fast Healthcare Interoperability Resources) JSON format. 
                                FHIR is a standardized format for exchanging healthcare data, and using this format ensures that your data is compatible 
                                with other healthcare systems. If you're importing data from another healthcare system or application, it's likely in FHIR
                                JSON format.
                            </p>
                            <label class="field-label required">Choose a data format</label>
                            <p-selectbutton 
                                [options]="importOptions" 
                                [(ngModel)]="importFormat" 
                                optionLabel="label" 
                                optionValue="value" 
                                aria-labelledby="basic" />
                        </div>
                    </div>
                    <div class="py-4">
                        <p-button label="Next" [disabled]="!importFormat" icon="pi pi-arrow-right" iconPos="right" (onClick)="activateCallback(2)" />
                    </div>
                </ng-template>
            </p-step-panel>
        </p-step-item>

        <p-step-item [value]="2">
            <p-step><span class="text-lg font-semibold">Upload the bundle</span></p-step>
            <p-step-panel>
                <ng-template #content let-activateCallback="activateCallback">
                    <div class="flex flex-column gap-2">
                        <label class="field-label required">Select the file to be imported</label>

                        <p-button [label]="importFormat=='pop+json' ? 'Load POP JSON' : 'Load FHIR JSON'" icon="pi pi-upload" (click)="fileInput.click()"/>
                        <input type="file"
                            accept=".json"
                            #fileInput
                            style="display: none"
                            (change)="onFileChange($event)"/>
                        <div *ngIf="uploadedFile">
                            <span class="font-semibold">Current file:</span> {{uploadedFile.name}}
                        </div>
                    </div>
                    <div class="flex pt-4 justify-between gap-2">
                        <p-button label="Back" severity="secondary" icon="pi pi-arrow-left" (onClick)="activateCallback(1)" />
                        <p-button label="Next" icon="pi pi-arrow-right" iconPos="right" [disabled]="!bundle" (onClick)="activateCallback(3)" />
                    </div>
                </ng-template>
            </p-step-panel>
        </p-step-item>

        <p-step-item [value]="3">
            <p-step><span class="text-lg font-semibold">Review the data</span></p-step>
            <p-step-panel>
                <ng-template #content let-activateCallback="activateCallback">
                    <div class="flex flex-col h-48">

                        <div>
                            <p-panel header="Import Content" *ngIf="bundle">
                                <p-tabs value="0">
                                    <p-tablist>
                                        <p-tab value="0">Parsed</p-tab>
                                        <p-tab value="1">JSON</p-tab>
                                        <p-tab value="2">Raw</p-tab>
                                    </p-tablist>
                                    <p-tabpanels>
                                        <p-tabpanel value="0">
                                                                                        
                                            <!-- Case summary -->
                                            <div class="mt-3 flex header" style="background: var(--p-content-background); color: var(--p-text-color); width: fit-content;">
                                                <p-avatar size="xlarge" [style]="{'background': 'none', 'width': '5rem', 'height': '5rem', 'padding': '0', 'margin': 'auto 0'}" >
                                                    <svg class="jdenticon my-auto" [data-jdenticon-value]="bundle.pseudoidentifier"></svg>
                                                </p-avatar>
                                                <div class="ml-3 my-auto">
                                                    <span class="text-muted">Case</span>
                                                    <h2 class="text-monospace my-0">
                                                        {{ bundle.pseudoidentifier }}
                                                    </h2>
                                                    <div>
                                                        {{ bundle.gender.display }}, 
                                                        {{ bundle.age }} years<span *ngIf="bundle.isDeceased">, â€ </span>
                                                    </div>
                                                </div>
                                                <p-divider layout="vertical"></p-divider>
                                                <div class="">
                                                    <div class="text-left">
                                                        <small class="text-muted">Overall survival</small>
                                                        <div>
                                                            <span>{{ (bundle.overall_survival | number:'1.0-0') || '?'}} months</span>      
                                                        </div>
                                                    </div> 

                                                    <div class="text-left mt-1">
                                                        <small class="text-muted">Cause of death</small>
                                                        <div>
                                                            <span>{{ bundle.causeOfDeath ? bundle.causeOfDeath.display : '-' }}</span>
                                                        </div>
                                                    </div> 
                                                </div>
                                                <p-divider layout="vertical"></p-divider>
                                                <div class="">
                                                    <div class="text-left">
                                                        <small class="text-muted">Clinical center</small>
                                                        <div>
                                                            <span>{{ bundle.clinicalCenter }}</span>      
                                                        </div>
                                                    </div> 

                                                    <div class="text-left mt-1">
                                                        <small class="text-muted">Clinical Identifier</small>
                                                        <div>
                                                            <span *ngIf="!authService.user.canAccessSensitiveData" style="opacity: 0.45;">ðŸž¸ðŸž¸ðŸž¸ðŸž¸ðŸž¸ðŸž¸ðŸž¸</span>
                                                            <span *ngIf="authService.user.canAccessSensitiveData">{{ bundle.clinicalIdentifier}}</span>
                                                        </div>
                                                    </div> 
                                                </div>
                                                <p-divider layout="vertical"></p-divider>
                                                <div class="">
                                                    <div class="text-left">
                                                        <small class="text-muted">Created</small>
                                                        <div>
                                                            <span>{{ bundle.createdAt | date }}</span>      
                                                        </div>
                                                    </div> 

                                                    <div class="text-left mt-1">
                                                        <small class="text-muted">Last updated</small>
                                                        <div>
                                                            <span>{{ bundle.updatedAt | date }}</span>      
                                                        </div>
                                                    </div> 
                                                </div>
                                            </div>

                                            <p-divider layout="horizontal"></p-divider>

                                            <small class="text-muted">Case resources</small>
                                            <p-tree [value]="bundleTree" styleClass="py-0 pl-0">
                                                <ng-template let-node pTemplate="category">                        
                                                    <div class="flex gap-2">
                                                        <div>{{ node.label }}</div> <p-badge badgeSize="small" [value]="node.children.length" [severity]="node.children.length ? 'primary' : 'secondary'"/>
                                                   </div>
                                                </ng-template>
                                                <ng-template let-node pTemplate="resource">                        
                                                    <div class="flex gap-2">
                                                        <i class="pi pi-file"></i><div class="font-semibold"><small>{{ node.data.date | date }}</small></div><div>{{ node.label }}</div> 
                                                   </div>
                                                </ng-template>
                                            </p-tree>
                                        </p-tabpanel>
                                        <p-tabpanel value="1">
                                            <ngx-json-viewer [json]="bundle" [expanded]="false"></ngx-json-viewer>
                                        </p-tabpanel>
                                        <p-tabpanel value="2">
                                            <pre> {{ bundle | json }} </pre>
                                        </p-tabpanel>
                                    </p-tabpanels>
                                </p-tabs>
                            </p-panel>
                        </div>
                    </div>
                    <div class="flex pt-4 justify-start gap-2">
                        <p-button label="Back" severity="secondary" icon="pi pi-arrow-left" (onClick)="activateCallback(2)" />
                        <p-button label="Next" icon="pi pi-arrow-right" iconPos="right" (onClick)="activateCallback(4)" />
                    </div>
                </ng-template>
            </p-step-panel>
        </p-step-item>

        <p-step-item [value]="4">
            <p-step><span class="text-lg font-semibold">Import the case</span></p-step>
            <p-step-panel>
                <ng-template #content let-activateCallback="activateCallback">
                    <div class="flex flex-col h-48">

                    </div>
                    <div class="flex pt-4 justify-start gap-2">
                        <p-button label="Back" severity="secondary" icon="pi pi-arrow-left" (onClick)="activateCallback(3)" />
                        <p-button label="Import case" icon="pi pi-cloud-upload" iconPos="right" (onClick)="onImportBundle()"/>
                    </div>
                </ng-template>
            </p-step-panel>
        </p-step-item>
        
    </p-stepper>
</div>
